import React, { useState, useEffect } from 'react';
import { Users, Eye, EyeOff, Play, RotateCcw, Crown, AlertCircle } from 'lucide-react';

const ImpostorGame = () => {
  const [gameState, setGameState] = useState('setup'); // setup, reveal, playing, voting, result
  const [numPlayers, setNumPlayers] = useState(3);
  const [currentPlayer, setCurrentPlayer] = useState(0);
  const [wordRevealed, setWordRevealed] = useState(false);
  const [selectedWord, setSelectedWord] = useState('');
  const [impostorIndex, setImpostorIndex] = useState(-1);
  const [timer, setTimer] = useState(40);
  const [votes, setVotes] = useState({});
  const [impostorGuess, setImpostorGuess] = useState('');
  const [customCategory, setCustomCategory] = useState('');
  const [customWords, setCustomWords] = useState('');
  const [customCategories, setCustomCategories] = useState({});
  const [loading, setLoading] = useState(true);

  const baseCategories = {
    'Animales': ['Perro', 'Gato', 'Elefante', 'Jirafa', 'Delf√≠n', 'Tigre', 'Ping√ºino', '√Åguila'],
    'Comida': ['Pizza', 'Hamburguesa', 'Sushi', 'Tacos', 'Helado', 'Pasta', 'Chocolate', 'Caf√©'],
    'Lugares': ['Playa', 'Monta√±a', 'Ciudad', 'Bosque', 'Desierto', 'Isla', 'Museo', 'Parque'],
    'Objetos': ['Mesa', 'Tel√©fono', 'Libro', 'Guitarra', 'Reloj', 'L√°piz', 'Botella', 'Zapato'],
    'Profesiones': ['M√©dico', 'Profesor', 'Chef', 'Polic√≠a', 'Bombero', 'Artista', 'M√∫sico', 'Piloto'],
    'Deportes': ['F√∫tbol', 'Basketball', 'Tenis', 'Nataci√≥n', 'Boxeo', 'Yoga', 'Golf', 'B√©isbol']
  };

  const [selectedCategory, setSelectedCategory] = useState('Animales');

  // Cargar categor√≠as guardadas al iniciar
  useEffect(() => {
    loadCustomCategories();
  }, []);

  const loadCustomCategories = async () => {
    try {
      const result = await window.storage.get('impostor-categories', true);
      if (result && result.value) {
        setCustomCategories(JSON.parse(result.value));
      }
    } catch (error) {
      console.log('No hay categor√≠as personalizadas guardadas a√∫n');
    }
    setLoading(false);
  };

  const saveCustomCategory = async () => {
    if (!customCategory.trim() || !customWords.trim()) {
      alert('Por favor completa ambos campos');
      return;
    }

    const wordsArray = customWords.split(',').map(w => w.trim()).filter(w => w);
    if (wordsArray.length < 3) {
      alert('Necesitas al menos 3 palabras para crear una categor√≠a');
      return;
    }

    const newCategories = {
      ...customCategories,
      [customCategory]: wordsArray
    };

    try {
      await window.storage.set('impostor-categories', JSON.stringify(newCategories), true);
      setCustomCategories(newCategories);
      setSelectedCategory(customCategory);
      setCustomCategory('');
      setCustomWords('');
      alert('¬°Categor√≠a guardada! Ahora todos pueden usarla üéâ');
    } catch (error) {
      alert('Error al guardar la categor√≠a. Intenta de nuevo.');
    }
  };

  const deleteCustomCategory = async (categoryName) => {
    const newCategories = { ...customCategories };
    delete newCategories[categoryName];

    try {
      await window.storage.set('impostor-categories', JSON.stringify(newCategories), true);
      setCustomCategories(newCategories);
      if (selectedCategory === categoryName) {
        setSelectedCategory('Animales');
      }
    } catch (error) {
      alert('Error al eliminar la categor√≠a');
    }
  };

  // Combinar categor√≠as base con personalizadas
  const allCategories = { ...baseCategories, ...customCategories };

  useEffect(() => {
    if (gameState === 'playing' && timer > 0) {
      const interval = setInterval(() => {
        setTimer(t => t - 1);
      }, 1000);
      return () => clearInterval(interval);
    }
  }, [gameState, timer]);

  const startGame = () => {
    const words = allCategories[selectedCategory];
    
    const word = words[Math.floor(Math.random() * words.length)];
    const impostor = Math.floor(Math.random() * numPlayers);
    
    setSelectedWord(word);
    setImpostorIndex(impostor);
    setGameState('reveal');
    setCurrentPlayer(0);
    setWordRevealed(false);
    setVotes({});
    setImpostorGuess('');
  };

  const nextPlayer = () => {
    if (currentPlayer < numPlayers - 1) {
      setCurrentPlayer(currentPlayer + 1);
      setWordRevealed(false);
    } else {
      setGameState('playing');
      setTimer(40);
    }
  };

  const revealWord = () => {
    setWordRevealed(true);
  };

  const goToVoting = () => {
    setGameState('voting');
  };

  const vote = (playerIndex) => {
    setVotes(prev => ({...prev, [currentPlayer]: playerIndex}));
    if (Object.keys(votes).length + 1 === numPlayers) {
      calculateResults();
    } else {
      setCurrentPlayer((currentPlayer + 1) % numPlayers);
    }
  };

  const calculateResults = () => {
    const voteCounts = {};
    Object.values(votes).forEach(vote => {
      voteCounts[vote] = (voteCounts[vote] || 0) + 1;
    });
    
    let maxVotes = 0;
    let suspectedImpostor = -1;
    Object.entries(voteCounts).forEach(([player, count]) => {
      if (count > maxVotes) {
        maxVotes = count;
        suspectedImpostor = parseInt(player);
      }
    });
    
    setCurrentPlayer(suspectedImpostor);
    setGameState('result');
  };

  const checkImpostorGuess = () => {
    const guessCorrect = impostorGuess.toLowerCase().trim() === selectedWord.toLowerCase().trim();
    setGameState('final');
    return guessCorrect;
  };

  const resetGame = () => {
    setGameState('setup');
    setCurrentPlayer(0);
    setWordRevealed(false);
    setTimer(40);
    setVotes({});
    setImpostorGuess('');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
      <style>{`
        @keyframes slideUp {
          from {
            transform: translateY(100%);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
        .perspective-1000 {
          perspective: 1000px;
        }
      `}</style>
      <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
        
        {/* SETUP */}
        {gameState === 'setup' && (
          <div className="space-y-6">
            <div className="text-center">
              <h1 className="text-4xl font-bold text-purple-900 mb-2">üïµÔ∏è El Impostor</h1>
              <p className="text-gray-600">Encuentra al impostor antes de que sea demasiado tarde</p>
            </div>

            {loading ? (
              <div className="text-center py-8">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-900 mx-auto"></div>
              </div>
            ) : (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    N√∫mero de jugadores (3-10)
                  </label>
                  <input
                    type="number"
                    min="3"
                    max="10"
                    value={numPlayers}
                    onChange={(e) => setNumPlayers(Math.max(3, Math.min(10, parseInt(e.target.value) || 3)))}
                    className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Categor√≠a de palabras
                  </label>
                  <select
                    value={selectedCategory}
                    onChange={(e) => setSelectedCategory(e.target.value)}
                    className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                  >
                    <optgroup label="Categor√≠as Base">
                      {Object.keys(baseCategories).map(cat => (
                        <option key={cat} value={cat}>{cat}</option>
                      ))}
                    </optgroup>
                    {Object.keys(customCategories).length > 0 && (
                      <optgroup label="Categor√≠as de la Comunidad">
                        {Object.keys(customCategories).map(cat => (
                          <option key={cat} value={cat}>{cat} ‚≠ê</option>
                        ))}
                      </optgroup>
                    )}
                  </select>
                </div>

                {/* Mostrar palabras de categor√≠a personalizada seleccionada */}
                {customCategories[selectedCategory] && (
                  <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <div className="flex justify-between items-start mb-2">
                      <p className="text-sm font-medium text-blue-900">
                        Categor√≠a creada por la comunidad ‚≠ê
                      </p>
                      <button
                        onClick={() => {
                          if (confirm('¬øEliminar esta categor√≠a para todos?')) {
                            deleteCustomCategory(selectedCategory);
                          }
                        }}
                        className="text-red-600 hover:text-red-800 text-xs"
                      >
                        üóëÔ∏è Eliminar
                      </button>
                    </div>
                    <p className="text-xs text-blue-700">
                      Palabras: {customCategories[selectedCategory].join(', ')}
                    </p>
                  </div>
                )}

                <div className="border-t-2 border-gray-200 pt-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ‚ûï Crear nueva categor√≠a para todos
                  </label>
                  <input
                    type="text"
                    placeholder="Nombre de categor√≠a (ej: Pel√≠culas Disney)"
                    value={customCategory}
                    onChange={(e) => setCustomCategory(e.target.value)}
                    className="w-full px-4 py-2 mb-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                  />
                  <input
                    type="text"
                    placeholder="Palabras separadas por comas (m√≠nimo 3)"
                    value={customWords}
                    onChange={(e) => setCustomWords(e.target.value)}
                    className="w-full px-4 py-2 mb-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                  />
                  <button
                    onClick={saveCustomCategory}
                    className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg transition-colors"
                  >
                    üíæ Guardar categor√≠a para toda la comunidad
                  </button>
                  <p className="text-xs text-gray-500 mt-2">
                    ‚ÑπÔ∏è Las categor√≠as que crees estar√°n disponibles para todos los jugadores
                  </p>
                </div>

                <button
                  onClick={startGame}
                  className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
                >
                  <Play size={20} />
                  Iniciar Juego
                </button>
              </div>
            )}
          </div>
        )}

        {/* REVEAL WORDS */}
        {gameState === 'reveal' && (
          <div className="text-center space-y-6">
            <h2 className="text-3xl font-bold text-purple-900">
              Jugador {currentPlayer + 1}
            </h2>
            
            {!wordRevealed ? (
              <div className="space-y-4">
                <p className="text-gray-600 mb-6">Desliza la carta hacia arriba para revelar</p>
                
                <div className="relative w-full max-w-sm mx-auto h-96 perspective-1000">
                  <div 
                    className="absolute inset-0 cursor-pointer"
                    onClick={revealWord}
                  >
                    {/* Carta de fondo (revelada) */}
                    <div className="absolute inset-0 rounded-2xl shadow-2xl overflow-hidden">
                      {currentPlayer === impostorIndex ? (
                        <div className="w-full h-full bg-gradient-to-br from-red-500 to-red-700 flex flex-col items-center justify-center p-8">
                          <AlertCircle className="mb-4 text-white" size={64} />
                          <p className="text-4xl font-bold text-white mb-2">IMPOSTOR</p>
                          <p className="text-white text-lg">¬°Pasa desapercibido!</p>
                        </div>
                      ) : (
                        <div className="w-full h-full bg-gradient-to-br from-green-500 to-green-700 flex flex-col items-center justify-center p-8">
                          <div className="bg-white/20 backdrop-blur-sm rounded-xl p-6 mb-4">
                            <p className="text-white text-lg mb-2">Tu palabra:</p>
                            <p className="text-5xl font-bold text-white">{selectedWord}</p>
                          </div>
                          <p className="text-white text-lg">¬°Da buenas pistas!</p>
                        </div>
                      )}
                    </div>
                    
                    {/* Carta de arriba (cover) */}
                    <div className="absolute inset-0 bg-gradient-to-br from-purple-600 to-blue-600 rounded-2xl shadow-2xl flex flex-col items-center justify-center transition-all duration-300 hover:scale-105">
                      <Eye className="text-white mb-4" size={64} />
                      <p className="text-white text-2xl font-bold mb-2">Toca para revelar</p>
                      <p className="text-white/80 text-sm">üëÜ Desliza hacia arriba</p>
                      <div className="absolute bottom-8 animate-bounce">
                        <div className="w-12 h-12 border-4 border-white rounded-full flex items-center justify-center">
                          <span className="text-white text-2xl">‚Üë</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            ) : (
              <div className="space-y-6">
                <div className="relative w-full max-w-sm mx-auto h-96">
                  <div className="absolute inset-0 rounded-2xl shadow-2xl overflow-hidden animate-[slideUp_0.5s_ease-out]">
                    {currentPlayer === impostorIndex ? (
                      <div className="w-full h-full bg-gradient-to-br from-red-500 to-red-700 flex flex-col items-center justify-center p-8">
                        <AlertCircle className="mb-4 text-white" size={64} />
                        <p className="text-4xl font-bold text-white mb-2">IMPOSTOR</p>
                        <p className="text-white text-lg">¬°Pasa desapercibido!</p>
                      </div>
                    ) : (
                      <div className="w-full h-full bg-gradient-to-br from-green-500 to-green-700 flex flex-col items-center justify-center p-8">
                        <div className="bg-white/20 backdrop-blur-sm rounded-xl p-6 mb-4">
                          <p className="text-white text-lg mb-2">Tu palabra:</p>
                          <p className="text-5xl font-bold text-white">{selectedWord}</p>
                        </div>
                        <p className="text-white text-lg">¬°Da buenas pistas!</p>
                      </div>
                    )}
                  </div>
                </div>
                
                <button
                  onClick={nextPlayer}
                  className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  {currentPlayer < numPlayers - 1 ? 'Siguiente Jugador' : 'Comenzar Ronda'}
                </button>
              </div>
            )}
          </div>
        )}

        {/* PLAYING */}
        {gameState === 'playing' && (
          <div className="text-center space-y-6">
            <h2 className="text-3xl font-bold text-purple-900">Ronda de Pistas</h2>
            
            <div className="bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg p-8">
              <p className="text-lg mb-2">Tiempo restante</p>
              <p className="text-6xl font-bold">{timer}s</p>
            </div>

            <div className="bg-gray-100 rounded-lg p-6">
              <p className="text-gray-700 mb-4">Cada jugador debe dar una pista relacionada con la palabra</p>
              <p className="text-sm text-gray-600">El impostor debe intentar adivinar la palabra bas√°ndose en las pistas</p>
            </div>

            <button
              onClick={goToVoting}
              className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-8 rounded-lg transition-colors"
            >
              Ir a Votaci√≥n
            </button>
          </div>
        )}

        {/* VOTING */}
        {gameState === 'voting' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold text-purple-900 text-center">
              Votaci√≥n - Jugador {currentPlayer + 1}
            </h2>
            
            <p className="text-center text-gray-600">¬øQui√©n crees que es el impostor?</p>

            <div className="grid grid-cols-2 gap-4">
              {Array.from({ length: numPlayers }).map((_, i) => (
                <button
                  key={i}
                  onClick={() => vote(i)}
                  disabled={i === currentPlayer}
                  className={`py-4 px-6 rounded-lg font-bold transition-colors ${
                    i === currentPlayer 
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                      : 'bg-purple-600 hover:bg-purple-700 text-white'
                  }`}
                >
                  Jugador {i + 1}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* RESULT */}
        {gameState === 'result' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold text-purple-900 text-center">
              ¬°Jugador {currentPlayer + 1} fue se√±alado!
            </h2>

            {currentPlayer === impostorIndex ? (
              <div className="space-y-4">
                <div className="bg-yellow-100 border-4 border-yellow-500 rounded-lg p-6 text-center">
                  <p className="text-xl font-bold text-yellow-700">¬°Encontraron al impostor!</p>
                  <p className="text-gray-700 mt-2">Impostor, tienes una oportunidad de adivinar la palabra</p>
                </div>

                <input
                  type="text"
                  placeholder="Adivina la palabra..."
                  value={impostorGuess}
                  onChange={(e) => setImpostorGuess(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-yellow-500 rounded-lg focus:outline-none focus:border-yellow-600"
                />

                <button
                  onClick={checkImpostorGuess}
                  className="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 rounded-lg transition-colors"
                >
                  Comprobar
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-red-100 border-4 border-red-500 rounded-lg p-6 text-center">
                  <p className="text-xl font-bold text-red-700">¬°Se√±alaron a la persona equivocada!</p>
                  <p className="text-gray-700 mt-2">El impostor era el Jugador {impostorIndex + 1}</p>
                  <p className="text-gray-700">La palabra era: <span className="font-bold">{selectedWord}</span></p>
                </div>

                <div className="bg-green-100 rounded-lg p-6 text-center">
                  <Crown className="mx-auto mb-2 text-green-600" size={48} />
                  <p className="text-2xl font-bold text-green-600">¬°El Impostor Gana!</p>
                </div>

                <button
                  onClick={resetGame}
                  className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
                >
                  <RotateCcw size={20} />
                  Jugar de Nuevo
                </button>
              </div>
            )}
          </div>
        )}

        {/* FINAL */}
        {gameState === 'final' && (
          <div className="space-y-6">
            {impostorGuess.toLowerCase().trim() === selectedWord.toLowerCase().trim() ? (
              <div className="space-y-4">
                <div className="bg-green-100 border-4 border-green-500 rounded-lg p-6 text-center">
                  <Crown className="mx-auto mb-2 text-green-600" size={48} />
                  <p className="text-2xl font-bold text-green-600">¬°El Impostor Gana!</p>
                  <p className="text-gray-700 mt-2">Adivin√≥ correctamente: <span className="font-bold">{selectedWord}</span></p>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-blue-100 border-4 border-blue-500 rounded-lg p-6 text-center">
                  <Users className="mx-auto mb-2 text-blue-600" size={48} />
                  <p className="text-2xl font-bold text-blue-600">¬°Los Jugadores Ganan!</p>
                  <p className="text-gray-700 mt-2">El impostor no pudo adivinar la palabra</p>
                  <p className="text-gray-700">La palabra era: <span className="font-bold">{selectedWord}</span></p>
                </div>
              </div>
            )}

            <button
              onClick={resetGame}
              className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
            >
              <RotateCcw size={20} />
              Jugar de Nuevo
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default ImpostorGame;
