import React, { useState, useEffect } from 'react';
import { Users, Eye, EyeOff, Play, RotateCcw, Crown, AlertCircle } from 'lucide-react';

const ImpostorGame = () => {
  const [gameState, setGameState] = useState('setup'); // setup, reveal, playing, voting, result
  const [numPlayers, setNumPlayers] = useState(3);
  const [currentPlayer, setCurrentPlayer] = useState(0);
  const [wordRevealed, setWordRevealed] = useState(false);
  const [selectedWord, setSelectedWord] = useState('');
  const [impostorIndex, setImpostorIndex] = useState(-1);
  const [timer, setTimer] = useState(40);
  const [votes, setVotes] = useState({});
  const [impostorGuess, setImpostorGuess] = useState('');
  const [customCategory, setCustomCategory] = useState('');
  const [customWords, setCustomWords] = useState('');

  const categories = {
    'Animales': ['Perro', 'Gato', 'Elefante', 'Jirafa', 'Delf√≠n', 'Tigre', 'Ping√ºino', '√Åguila'],
    'Comida': ['Pizza', 'Hamburguesa', 'Sushi', 'Tacos', 'Helado', 'Pasta', 'Chocolate', 'Caf√©'],
    'Lugares': ['Playa', 'Monta√±a', 'Ciudad', 'Bosque', 'Desierto', 'Isla', 'Museo', 'Parque'],
    'Objetos': ['Mesa', 'Tel√©fono', 'Libro', 'Guitarra', 'Reloj', 'L√°piz', 'Botella', 'Zapato'],
    'Profesiones': ['M√©dico', 'Profesor', 'Chef', 'Polic√≠a', 'Bombero', 'Artista', 'M√∫sico', 'Piloto'],
    'Deportes': ['F√∫tbol', 'Basketball', 'Tenis', 'Nataci√≥n', 'Boxeo', 'Yoga', 'Golf', 'B√©isbol']
  };

  const [selectedCategory, setSelectedCategory] = useState('Animales');

  useEffect(() => {
    if (gameState === 'playing' && timer > 0) {
      const interval = setInterval(() => {
        setTimer(t => t - 1);
      }, 1000);
      return () => clearInterval(interval);
    }
  }, [gameState, timer]);

  const startGame = () => {
    const words = customCategory && customWords 
      ? customWords.split(',').map(w => w.trim()).filter(w => w)
      : categories[selectedCategory];
    
    const word = words[Math.floor(Math.random() * words.length)];
    const impostor = Math.floor(Math.random() * numPlayers);
    
    setSelectedWord(word);
    setImpostorIndex(impostor);
    setGameState('reveal');
    setCurrentPlayer(0);
    setWordRevealed(false);
    setVotes({});
    setImpostorGuess('');
  };

  const nextPlayer = () => {
    if (currentPlayer < numPlayers - 1) {
      setCurrentPlayer(currentPlayer + 1);
      setWordRevealed(false);
    } else {
      setGameState('playing');
      setTimer(40);
    }
  };

  const revealWord = () => {
    setWordRevealed(true);
  };

  const goToVoting = () => {
    setGameState('voting');
  };

  const vote = (playerIndex) => {
    setVotes(prev => ({...prev, [currentPlayer]: playerIndex}));
    if (Object.keys(votes).length + 1 === numPlayers) {
      calculateResults();
    } else {
      setCurrentPlayer((currentPlayer + 1) % numPlayers);
    }
  };

  const calculateResults = () => {
    const voteCounts = {};
    Object.values(votes).forEach(vote => {
      voteCounts[vote] = (voteCounts[vote] || 0) + 1;
    });
    
    let maxVotes = 0;
    let suspectedImpostor = -1;
    Object.entries(voteCounts).forEach(([player, count]) => {
      if (count > maxVotes) {
        maxVotes = count;
        suspectedImpostor = parseInt(player);
      }
    });
    
    setCurrentPlayer(suspectedImpostor);
    setGameState('result');
  };

  const checkImpostorGuess = () => {
    const guessCorrect = impostorGuess.toLowerCase().trim() === selectedWord.toLowerCase().trim();
    setGameState('final');
    return guessCorrect;
  };

  const resetGame = () => {
    setGameState('setup');
    setCurrentPlayer(0);
    setWordRevealed(false);
    setTimer(40);
    setVotes({});
    setImpostorGuess('');
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
        
        {/* SETUP */}
        {gameState === 'setup' && (
          <div className="space-y-6">
            <div className="text-center">
              <h1 className="text-4xl font-bold text-purple-900 mb-2">üïµÔ∏è El Impostor</h1>
              <p className="text-gray-600">Encuentra al impostor antes de que sea demasiado tarde</p>
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  N√∫mero de jugadores (3-10)
                </label>
                <input
                  type="number"
                  min="3"
                  max="10"
                  value={numPlayers}
                  onChange={(e) => setNumPlayers(Math.max(3, Math.min(10, parseInt(e.target.value) || 3)))}
                  className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Categor√≠a de palabras
                </label>
                <select
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                >
                  {Object.keys(categories).map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>

              <div className="border-t-2 border-gray-200 pt-4">
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  O usa palabras personalizadas
                </label>
                <input
                  type="text"
                  placeholder="Nombre de categor√≠a"
                  value={customCategory}
                  onChange={(e) => setCustomCategory(e.target.value)}
                  className="w-full px-4 py-2 mb-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                />
                <input
                  type="text"
                  placeholder="Palabras separadas por comas"
                  value={customWords}
                  onChange={(e) => setCustomWords(e.target.value)}
                  className="w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:outline-none focus:border-purple-500"
                />
              </div>

              <button
                onClick={startGame}
                className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
              >
                <Play size={20} />
                Iniciar Juego
              </button>
            </div>
          </div>
        )}

        {/* REVEAL WORDS */}
        {gameState === 'reveal' && (
          <div className="text-center space-y-6">
            <h2 className="text-3xl font-bold text-purple-900">
              Jugador {currentPlayer + 1}
            </h2>
            
            {!wordRevealed ? (
              <div className="space-y-4">
                <p className="text-gray-600">Presiona para ver tu palabra (los dem√°s no deben mirar)</p>
                <button
                  onClick={revealWord}
                  className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg flex items-center justify-center gap-2 mx-auto transition-colors"
                >
                  <Eye size={24} />
                  Ver Palabra
                </button>
              </div>
            ) : (
              <div className="space-y-6">
                {currentPlayer === impostorIndex ? (
                  <div className="bg-red-100 border-4 border-red-500 rounded-lg p-8">
                    <AlertCircle className="mx-auto mb-4 text-red-600" size={48} />
                    <p className="text-3xl font-bold text-red-600">¬°ERES EL IMPOSTOR!</p>
                    <p className="text-gray-700 mt-2">No conoces la palabra. Trata de pasar desapercibido.</p>
                  </div>
                ) : (
                  <div className="bg-green-100 border-4 border-green-500 rounded-lg p-8">
                    <p className="text-gray-700 mb-2">Tu palabra es:</p>
                    <p className="text-4xl font-bold text-green-600">{selectedWord}</p>
                  </div>
                )}
                
                <button
                  onClick={nextPlayer}
                  className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"
                >
                  {currentPlayer < numPlayers - 1 ? 'Siguiente Jugador' : 'Comenzar Ronda'}
                </button>
              </div>
            )}
          </div>
        )}

        {/* PLAYING */}
        {gameState === 'playing' && (
          <div className="text-center space-y-6">
            <h2 className="text-3xl font-bold text-purple-900">Ronda de Pistas</h2>
            
            <div className="bg-gradient-to-r from-purple-500 to-blue-500 text-white rounded-lg p-8">
              <p className="text-lg mb-2">Tiempo restante</p>
              <p className="text-6xl font-bold">{timer}s</p>
            </div>

            <div className="bg-gray-100 rounded-lg p-6">
              <p className="text-gray-700 mb-4">Cada jugador debe dar una pista relacionada con la palabra</p>
              <p className="text-sm text-gray-600">El impostor debe intentar adivinar la palabra bas√°ndose en las pistas</p>
            </div>

            <button
              onClick={goToVoting}
              className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-8 rounded-lg transition-colors"
            >
              Ir a Votaci√≥n
            </button>
          </div>
        )}

        {/* VOTING */}
        {gameState === 'voting' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold text-purple-900 text-center">
              Votaci√≥n - Jugador {currentPlayer + 1}
            </h2>
            
            <p className="text-center text-gray-600">¬øQui√©n crees que es el impostor?</p>

            <div className="grid grid-cols-2 gap-4">
              {Array.from({ length: numPlayers }).map((_, i) => (
                <button
                  key={i}
                  onClick={() => vote(i)}
                  disabled={i === currentPlayer}
                  className={`py-4 px-6 rounded-lg font-bold transition-colors ${
                    i === currentPlayer 
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                      : 'bg-purple-600 hover:bg-purple-700 text-white'
                  }`}
                >
                  Jugador {i + 1}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* RESULT */}
        {gameState === 'result' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold text-purple-900 text-center">
              ¬°Jugador {currentPlayer + 1} fue se√±alado!
            </h2>

            {currentPlayer === impostorIndex ? (
              <div className="space-y-4">
                <div className="bg-yellow-100 border-4 border-yellow-500 rounded-lg p-6 text-center">
                  <p className="text-xl font-bold text-yellow-700">¬°Encontraron al impostor!</p>
                  <p className="text-gray-700 mt-2">Impostor, tienes una oportunidad de adivinar la palabra</p>
                </div>

                <input
                  type="text"
                  placeholder="Adivina la palabra..."
                  value={impostorGuess}
                  onChange={(e) => setImpostorGuess(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-yellow-500 rounded-lg focus:outline-none focus:border-yellow-600"
                />

                <button
                  onClick={checkImpostorGuess}
                  className="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-4 rounded-lg transition-colors"
                >
                  Comprobar
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-red-100 border-4 border-red-500 rounded-lg p-6 text-center">
                  <p className="text-xl font-bold text-red-700">¬°Se√±alaron a la persona equivocada!</p>
                  <p className="text-gray-700 mt-2">El impostor era el Jugador {impostorIndex + 1}</p>
                  <p className="text-gray-700">La palabra era: <span className="font-bold">{selectedWord}</span></p>
                </div>

                <div className="bg-green-100 rounded-lg p-6 text-center">
                  <Crown className="mx-auto mb-2 text-green-600" size={48} />
                  <p className="text-2xl font-bold text-green-600">¬°El Impostor Gana!</p>
                </div>

                <button
                  onClick={resetGame}
                  className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
                >
                  <RotateCcw size={20} />
                  Jugar de Nuevo
                </button>
              </div>
            )}
          </div>
        )}

        {/* FINAL */}
        {gameState === 'final' && (
          <div className="space-y-6">
            {impostorGuess.toLowerCase().trim() === selectedWord.toLowerCase().trim() ? (
              <div className="space-y-4">
                <div className="bg-green-100 border-4 border-green-500 rounded-lg p-6 text-center">
                  <Crown className="mx-auto mb-2 text-green-600" size={48} />
                  <p className="text-2xl font-bold text-green-600">¬°El Impostor Gana!</p>
                  <p className="text-gray-700 mt-2">Adivin√≥ correctamente: <span className="font-bold">{selectedWord}</span></p>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="bg-blue-100 border-4 border-blue-500 rounded-lg p-6 text-center">
                  <Users className="mx-auto mb-2 text-blue-600" size={48} />
                  <p className="text-2xl font-bold text-blue-600">¬°Los Jugadores Ganan!</p>
                  <p className="text-gray-700 mt-2">El impostor no pudo adivinar la palabra</p>
                  <p className="text-gray-700">La palabra era: <span className="font-bold">{selectedWord}</span></p>
                </div>
              </div>
            )}

            <button
              onClick={resetGame}
              className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors"
            >
              <RotateCcw size={20} />
              Jugar de Nuevo
            </button>
          </div>
        )}
      </div>
    </div>
  );
};

export default ImpostorGame;
